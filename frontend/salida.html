<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registrar Salida - ParkFlow</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="app-layout">
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-logo">
                <i class="fas fa-square-parking sidebar-logo-icon"></i>
                <span class="sidebar-logo-text">ParkFlow</span>
            </div>
            <div class="sidebar-user">
                <div class="sidebar-user-avatar"><i class="fas fa-user"></i></div>
                <div class="sidebar-user-info">
                    <div class="sidebar-user-name" id="userName">Usuario</div>
                    <div class="sidebar-user-role" id="userRole">Rol</div>
                </div>
            </div>
            <nav class="sidebar-nav">
                <div class="sidebar-nav-section">MENÚ PRINCIPAL</div>
                <a href="dashboard.html" class="sidebar-nav-item" data-page="dashboard">
                    <i class="fas fa-home"></i><span>Dashboard</span>
                </a>
                <div class="sidebar-nav-section">OPERACIONES</div>
                <a href="entrada.html" class="sidebar-nav-item" data-page="entrada">
                    <i class="fas fa-car-side"></i><span>Registrar Entrada</span>
                </a>
                <a href="salida.html" class="sidebar-nav-item active" data-page="salida">
                    <i class="fas fa-right-from-bracket"></i><span>Registrar Salida</span>
                </a>
                <a href="activos.html" class="sidebar-nav-item" data-page="activos">
                    <i class="fas fa-list-check"></i><span>Vehículos Activos</span>
                </a>
                <a href="cupos.html" class="sidebar-nav-item" data-page="cupos">
                    <i class="fas fa-square-parking"></i><span>Consultar Cupos</span>
                </a>
                <div class="sidebar-nav-section admin-only" style="display:none;">ADMINISTRACIÓN</div>
                <a href="tarifas.html" class="sidebar-nav-item admin-only" data-page="tarifas" style="display:none;">
                    <i class="fas fa-tags"></i><span>Gestión de Tarifas</span>
                </a>
                <a href="usuarios.html" class="sidebar-nav-item admin-only" data-page="usuarios" style="display:none;">
                    <i class="fas fa-users"></i><span>Gestión de Usuarios</span>
                </a>
                <a href="reportes.html" class="sidebar-nav-item admin-only" data-page="reportes" style="display:none;">
                    <i class="fas fa-chart-bar"></i><span>Reportes</span>
                </a>
            </nav>
            <div class="sidebar-footer">
                <button onclick="toggleSidebar()" class="sidebar-toggle-btn">
                    <i class="fas fa-bars"></i><span>Colapsar</span>
                </button>
                <button onclick="logout()" class="sidebar-logout-btn">
                    <i class="fas fa-sign-out-alt"></i><span>Cerrar Sesión</span>
                </button>
            </div>
        </aside>

        <main class="main-content">
            <div class="topbar">
                <div>
                    <div class="topbar-title">➡️ Registrar Salida de Vehículo</div>
                    <div class="topbar-subtitle">Busque el vehículo y procese su salida</div>
                </div>
            </div>

            <div class="content-area">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">
                                <i class="fas fa-search"></i> Buscar Vehículo
                            </div>
                        </div>
                        <form id="buscarForm">
                            <div class="form-group">
                                <label class="form-label">
                                    <i class="fas fa-hashtag"></i> Placa del Vehículo
                                </label>
                                <input type="text" id="placaBuscar" class="form-input" placeholder="Ej: ABC123" style="text-transform: uppercase;">
                            </div>
                            <button type="submit" class="btn btn-primary" style="width: 100%;">
                                <i class="fas fa-search"></i> Buscar
                            </button>
                        </form>

                        <div id="vehiculoInfo" style="display:none; margin-top: 24px; padding: 20px; background: var(--gray-50); border-radius: 12px;">
                            <h3 style="margin-bottom: 16px; color: var(--primary);"><i class="fas fa-info-circle"></i> Información del Vehículo</h3>
                            <div style="display: grid; gap: 12px;">
                                <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--gray-200);">
                                    <strong>Placa:</strong>
                                    <span id="infoPlaca"></span>
                                </div>
                                <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--gray-200);">
                                    <strong>Tipo:</strong>
                                    <span id="infoTipo"></span>
                                </div>
                                <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--gray-200);">
                                    <strong>Espacio:</strong>
                                    <span id="infoEspacio" class="badge badge-purple"></span>
                                </div>
                                <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--gray-200);">
                                    <strong>Hora Entrada:</strong>
                                    <span id="infoEntrada"></span>
                                </div>
                                <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--gray-200);">
                                    <strong>Tiempo:</strong>
                                    <span id="infoTiempo" style="color: var(--primary); font-weight: 600;"></span>
                                </div>
                                <div style="display: flex; justify-content: space-between; padding: 12px 0; background: white; margin-top: 8px; border-radius: 8px; padding: 16px;">
                                    <strong style="font-size: 18px;">Total a Pagar:</strong>
                                    <span id="infoTotal" style="font-size: 24px; font-weight: 700; color: var(--success);"></span>
                                </div>
                            </div>

                            <div style="margin-top: 20px;">
                                <label class="form-label">Descuento (opcional)</label>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                                    <input type="number" id="descuentoPorcentaje" class="form-input" placeholder="% Descuento" min="0" max="100">
                                    <input type="number" id="descuentoFijo" class="form-input" placeholder="$ Fijo" min="0">
                                </div>
                            </div>

                            <button onclick="procesarSalida()" class="btn btn-success" style="width: 100%; margin-top: 20px; font-size: 16px;">
                                <i class="fas fa-check-circle"></i> Procesar Salida y Cobrar
                            </button>
                        </div>

                        <div id="mensaje" class="alert" style="display: none; margin-top: 16px;"></div>
                    </div>

                    <div>
                        <div class="card">
                            <div class="card-header">
                                <div class="card-title">
                                    <i class="fas fa-clock"></i> Vehículos Activos Recientes
                                </div>
                            </div>
                            <div id="vehiculosActivos">
                                <div class="loading"><i class="fas fa-spinner"></i> Cargando...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="js/app.js"></script>
    <script>
        let vehiculoActual = null;

        async function cargarVehiculosActivos() {
            try {
                const token = localStorage.getItem('parking_token');
                const res = await fetch(`${API_URL}/vehiculos/activos`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();

                if (data.success) {
                    const container = document.getElementById('vehiculosActivos');
                    if (data.vehiculos.length === 0) {
                        container.innerHTML = '<p style="text-align: center; padding: 20px; color: var(--gray-600);">No hay vehículos activos</p>';
                        return;
                    }

                    container.innerHTML = data.vehiculos.slice(0, 10).map(v => `
                        <div style="padding: 12px; border-bottom: 1px solid var(--gray-200); cursor: pointer;" onclick="buscarVehiculo('${v.placa}')">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div style="font-weight: 600; font-size: 16px;">${v.placa}</div>
                                    <div style="font-size: 13px; color: var(--gray-600);">
                                        <i class="fas fa-car"></i> ${v.tipo_vehiculo} - ${v.espacio}
                                    </div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-size: 14px; font-weight: 600; color: var(--primary);">${v.tiempo_transcurrido || '0 min'}</div>
                                    <div style="font-size: 12px; color: var(--gray-600);">${formatearFecha(v.fecha_hora_entrada)}</div>
                                </div>
                            </div>
                        </div>
                    `).join('');
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        async function buscarVehiculo(placa) {
            if (!placa) placa = document.getElementById('placaBuscar').value.trim().toUpperCase();
            if (!placa) return;

            const mensaje = document.getElementById('mensaje');
            mensaje.style.display = 'none';

            try {
                const token = localStorage.getItem('parking_token');
                const res = await fetch(`${API_URL}/vehiculos/buscar/${placa}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();

                if (data.success && data.vehiculo) {
                    vehiculoActual = data.vehiculo;
                    mostrarInfoVehiculo(data.vehiculo);
                } else {
                    mensaje.textContent = 'Vehículo no encontrado o ya salió';
                    mensaje.className = 'alert alert-error';
                    mensaje.style.display = 'block';
                    document.getElementById('vehiculoInfo').style.display = 'none';
                }
            } catch (error) {
                console.error('Error:', error);
                mensaje.textContent = 'Error al buscar vehículo';
                mensaje.className = 'alert alert-error';
                mensaje.style.display = 'block';
            }
        }

        function mostrarInfoVehiculo(vehiculo) {
            document.getElementById('infoPlaca').textContent = vehiculo.placa;
            document.getElementById('infoTipo').textContent = vehiculo.tipo_vehiculo;
            document.getElementById('infoEspacio').textContent = vehiculo.numero_espacio || vehiculo.espacio;
            document.getElementById('infoEntrada').textContent = formatearFecha(vehiculo.fecha_hora_entrada);
            
            // Calcular tiempo transcurrido
            const minutos = vehiculo.tiempo_minutos || 0;
            const horas = Math.floor(minutos / 60);
            const mins = minutos % 60;
            let tiempoTexto = '';
            if (horas > 0) {
                tiempoTexto = `${horas}h ${mins}m`;
            } else {
                tiempoTexto = `${mins} min`;
            }
            document.getElementById('infoTiempo').textContent = tiempoTexto;
            
            document.getElementById('infoTotal').textContent = formatearMonto(vehiculo.monto_estimado || 0);
            document.getElementById('vehiculoInfo').style.display = 'block';
            document.getElementById('placaBuscar').value = vehiculo.placa;
        }

        async function procesarSalida() {
            if (!vehiculoActual) return;

            const descuentoPorcentaje = parseFloat(document.getElementById('descuentoPorcentaje').value) || 0;
            const descuentoFijo = parseFloat(document.getElementById('descuentoFijo').value) || 0;
            const mensaje = document.getElementById('mensaje');

            if (descuentoPorcentaje < 0 || descuentoPorcentaje > 100) {
                alert('El descuento porcentual debe estar entre 0 y 100');
                return;
            }

            if (descuentoFijo < 0) {
                alert('El descuento fijo no puede ser negativo');
                return;
            }

            if (!confirm(`¿Confirmar salida del vehículo ${vehiculoActual.placa}?`)) return;

            try {
                const token = localStorage.getItem('parking_token');
                const res = await fetch(`${API_URL}/vehiculos/salida`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        registro_id: vehiculoActual.id,
                        descuento_porcentaje: descuentoPorcentaje,
                        descuento_valor: descuentoFijo
                    })
                });

                const data = await res.json();

                if (data.success) {
                    mensaje.textContent = `¡Salida registrada! Total cobrado: ${formatearMonto(data.registro.monto_final)}`;
                    mensaje.className = 'alert alert-success';
                    mensaje.style.display = 'block';

                    document.getElementById('vehiculoInfo').style.display = 'none';
                    document.getElementById('placaBuscar').value = '';
                    document.getElementById('descuentoPorcentaje').value = '';
                    document.getElementById('descuentoFijo').value = '';
                    vehiculoActual = null;

                    await cargarVehiculosActivos();
                } else {
                    mensaje.textContent = data.message || 'Error al procesar salida';
                    mensaje.className = 'alert alert-error';
                    mensaje.style.display = 'block';
                }
            } catch (error) {
                console.error('Error:', error);
                mensaje.textContent = 'Error de conexión';
                mensaje.className = 'alert alert-error';
                mensaje.style.display = 'block';
            }
        }

        document.getElementById('buscarForm').addEventListener('submit', function(e) {
            e.preventDefault();
            buscarVehiculo();
        });

        document.getElementById('placaBuscar').addEventListener('input', function() {
            this.value = this.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
        });

        document.addEventListener('DOMContentLoaded', function() {
            cargarVehiculosActivos();
            setInterval(cargarVehiculosActivos, 30000);
        });
    </script>
</body>
</html>
